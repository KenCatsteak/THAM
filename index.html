<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>台畜禮盒預購單</title>
    <style>
        body { font-family: Arial, "Microsoft JhengHei", sans-serif; max-width: 700px; margin: 20px auto; line-height: 1.6; }
        h2 { text-align: center; margin-bottom: 20px; }
        .item { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
input[type="text"], input[type="number"] {
    padding: 10px 14px;
    width: 100%;
    max-width: 320px;
    font-size: 16px;
    box-sizing: border-box;
}

/* 品項數量欄位：寬一點，橫向排列好看 */
input.qty {
    max-width: 120px;
    display: inline-block;
}

        #total { font-weight: bold; font-size: 1.3em; margin-top: 20px; }
        button {
            cursor: pointer;
        }
.discount-price {
    color: #cc0000;       /* 深紅色 */
    font-weight: bold;    /* 粗體 */
    font-size: 1.25em;    /* 放大 25% */
}
        
    </style>
</head>
<body>

<h2>台畜禮盒預購單</h2>

<div class="item">
    <label for="name">姓名</label>
    <input type="text" id="name" required>
</div>

<div class="item">
    <label for="phone">手機號碼</label>
    <input type="text" id="phone" required>
</div>

<div class="item">
    <label for="address">收件地址</label>
    <input type="text" id="address" required>
</div>

<div class="item">
    <label>匯款帳號後五碼（必填，僅限數字）</label>
    <input type="text"
           id="bank_last5"
           class="numeric"
           maxlength="5"
           inputmode="numeric"
           pattern="[0-9]{5}"
           placeholder="請輸入 5 碼數字"
           required>
</div>
        
    <div class="item">
    <label for="note">備註（選填）</label>
    <textarea id="note" rows="3" style="width:100%; max-width:320px; padding:10px 14px; font-size:16px; box-sizing:border-box;" placeholder="若有特殊需求或備註可填寫在此"></textarea>
</div>


<hr>

<div class="item">
    <label>A. 燻烤前腿禮盒 3.7kg $3680</label>
    <input type="number" class="qty numeric" data-price="3680" data-name="燻烤前腿禮盒 3.7kg" min="0" value="0" inputmode="numeric">
</div>

<div class="item">
    <label>B. 燻烤前腿禮盒 2.3kg $2180</label>
    <input type="number" class="qty numeric" data-price="2180" data-name="燻烤前腿禮盒 2.3kg" min="0" value="0" inputmode="numeric">
</div>

<div class="item">
    <label>C. 醺藏盛饌禮盒 (燻烤前腿2.3kg+智利施赫頂級陳年紅酒750ml) $3180</label>
    <input type="number" class="qty numeric" data-price="3180" data-name="醺藏盛饌禮盒（含紅酒）" min="0" value="0" inputmode="numeric">
</div>

<div class="item">
    <label>D. 烏骨珍饌禮盒（台酒烏雞酒+黑蒜元氣雞湯） $1980</label>
    <input type="number" class="qty numeric" data-price="1980" data-name="烏骨珍饌禮盒（烏雞酒+湯）" min="0" value="0" inputmode="numeric">
</div>

<div class="item">
    <label>E. 谷川臻味禮盒（谷川岳500g+智利施赫頂級陳年紅酒750ml） $1880</label>
    <input type="number" class="qty numeric" data-price="1880" data-name="谷川臻味禮盒（含紅酒）" min="0" value="0" inputmode="numeric">
</div>

<div class="item">
    <label>F. 三福肉酥禮盒 (原味肉酥*2 海苔肉酥*1) $1180</label>
    <input type="number" class="qty numeric" data-price="1180" data-name="三福肉酥禮盒" min="0" value="0" inputmode="numeric">
</div>

<div class="item">
    <label>G. 聚味好年禮盒 (原味肉酥+海苔肉酥+肝腸+臘腸) $1280</label>
    <input type="number" class="qty numeric" data-price="1280" data-name="聚味好年禮盒" min="0" value="0" inputmode="numeric">
</div>

<div class="item">
    <label>H. 肉酥禮盒 (原味肉酥+海苔肉酥) $780</label>
    <input type="number" class="qty numeric" data-price="780" data-name="肉酥禮盒" min="0" value="0" inputmode="numeric">
</div>

<div class="item">
    <label>I. 雙饗肉乾禮盒(杏仁肉片(原味+海苔+黑胡椒)) $880</label>
    <input type="number" class="qty numeric" data-price="880" data-name="雙饗肉乾禮盒" min="0" value="0" inputmode="numeric">
</div>


<hr>

<div id="total">總金額：NT$ 0</div>
<div id="discount" class="discount-price">九折後金額（90%）：NT$ 0</div>


<hr>

<div class="item">
    <h3>匯款資訊</h3>
    <p>
        銀行代號：<strong>彰化銀行（009）</strong><br>
        銀行帳號：<strong>5272-01-0866-130</strong>
    </p>
    <p style="color: #b00000;">
        請於匯款完成後填寫上方欄位，方便我們對帳
    </p>
</div>

<hr>

<button id="submitBtn" onclick="submitOrder()" style="padding:12px 20px;font-size:16px;">
    送出訂單
</button>

<script>
    const qtyInputs = document.querySelectorAll('.qty');
    const totalEl = document.getElementById('total');
    const discountEl = document.getElementById('discount');
    const submitBtn = document.getElementById('submitBtn');

    // 僅允許數字輸入的欄位
    const numericInputs = document.querySelectorAll('.numeric');
    numericInputs.forEach(input => {
        input.addEventListener('input', function () {
            this.value = this.value.replace(/\D/g, '');
        });
    });

    function calculateTotal() {
        let sum = 0;
        qtyInputs.forEach(input => {
            const price = parseInt(input.dataset.price, 10);
            const qty = parseInt(input.value, 10) || 0;
            sum += price * qty;
        });

        totalEl.textContent = '總金額：NT$ ' + sum.toLocaleString();

        const discount = Math.ceil(sum * 0.9);
        discountEl.textContent = '九折後金額（90%）：NT$ ' + discount.toLocaleString();
    }

    qtyInputs.forEach(input => {
        input.addEventListener('input', calculateTotal);
    });

    function collectItems() {
        const items = [];
        document.querySelectorAll(".qty").forEach(input => {
            const qty = parseInt(input.value, 10);
            if (qty > 0) {
                const name = input.dataset.name;
                items.push(name + " x" + qty);
            }
        });
        return items.join("\n");
    }

    function generateOrderId() {
        const now = new Date();
        const date = now.toISOString().slice(0, 10).replace(/-/g, "");
        const rand = Math.floor(100 + Math.random() * 900);
        return "THAM-" + date + "-" + rand;
    }

    function submitOrder() {
        const name = document.getElementById("name").value.trim();
        const phone = document.getElementById("phone").value.trim();
        const address = document.getElementById("address").value.trim();
        const last5 = document.getElementById("bank_last5").value.trim();
        const note = document.getElementById("note").value.trim();

        if (!name || !phone || !address) {
            alert("請先完整填寫姓名、手機號碼與收件地址。");
            return;
        }

        if (!/^\d{5}$/.test(last5)) {
            alert("請正確填寫匯款帳號後五碼（5 位數字）。");
            return;
        }

        const orderId = generateOrderId();
        const items = collectItems();

        const totalStr = totalEl.textContent.replace(/[^\d]/g, "") || "0";
        const totalNum = Number(totalStr);

        if (!Number.isFinite(totalNum)) {
            alert("金額計算異常（非數字），請重新整理頁面再試一次。");
            return;
        }

        if (totalNum <= 0) {
            if (!confirm("目前總金額為 0 元，確定要送出訂單嗎？")) {
                return;
            }
        }

        const payload = {
            orderId: orderId,
            name: name,
            phone: phone,
            address: address,
            total: totalNum,
            bankLast5: last5,
            items: items,
            note: note
        };

        const scriptUrl = "https://script.google.com/macros/s/AKfycbwmBcRI63_nsjcSpEKi-DWH-ZsUxNR8xA5lD7taUczavCX_YiQzizTqO8rabLNoLiAthg/exec";
        const urlWithParams = scriptUrl + "?" + new URLSearchParams(payload).toString();

        submitBtn.disabled = true;
        submitBtn.textContent = "送出中，請稍候…";

        fetch(urlWithParams, { method: "GET" })
            .then(res => res.text())
            .then(text => {
                if (text.trim() === "OK") {
                    alert("訂單送出成功！\n訂單編號：" + orderId);
                    submitBtn.disabled = true;
                    submitBtn.textContent = "已送出";
                } else {
                    alert("訂單已送出，但伺服器回應異常：" + text);
                    submitBtn.disabled = false;
                    submitBtn.textContent = "送出訂單";
                }
            })
            .catch(() => {
                alert("訂單送出失敗，請稍後再試。");
                submitBtn.disabled = false;
                submitBtn.textContent = "送出訂單";
            });
    }

    // 載入時先跑一次計算
    calculateTotal();
</script>

</body>
</html>
